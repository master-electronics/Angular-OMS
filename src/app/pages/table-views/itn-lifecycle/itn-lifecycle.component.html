<div class="container px-4 py-4" style="max-width: 200%;">
  <form nz-form [formGroup]="filterForm">
    <div nz-row nzGutter="8" nzJustify="space-between">
      <nz-form-item nz-col nzSpan="8">
        <nz-form-label nzRequired> Date </nz-form-label>
        <nz-form-control>
          <nz-date-picker formControlName="timeRange"></nz-date-picker>
          <nz-select class="templateSelect" [ngModel]="" [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onTemplateChange($event)" nzPlaceHolder="Select Template">
            <nz-option *ngFor="let template of templates" nzValue="{{ template.id }},{{ template.name }}"
              nzLabel="{{ template.name }}"></nz-option>
          </nz-select>
          <template-settings (modalClosed)="onModalClose()" [templates]="templates" [columns]="columns"
            [selectedColumns]="[]" [templateNameValue]="templateNameValue"
            [activeTemplateId]="templateId"></template-settings>
        </nz-form-control>

      </nz-form-item>

      <div nz-col nzSpan="10">
        <button nz-button [nzType]="'primary'" (click)="onSubmit()" [disabled]="isLoading" class="mr-4">
          Search
        </button>
        <button nz-button (click)="resetForm()" class="mr-4">Clear</button>
        <button nz-button (click)="exportexcel()">Export to Excel</button>
      </div>
    </div>
  </form>
  <!-- Event log table -->
  <div *ngIf="fetchTable$ | async"></div>
  <ng-template #indicatorTemplate><i nz-icon nzType="loading"></i></ng-template>
  <div class="progress" *ngIf="isLoading" >
    <nz-spin nzSimple [nzSize]="'large'"></nz-spin>
  </div>
  <nz-table id="excel-table" #table [nzPageSize]="pageSize" 
    [nzFrontPagination]="paging" nzShowSizeChanger [nzData]="tableDataDisplay" nzBordered
    [nzPageSizeOptions]="paginationValues" [nzScroll]="{ y: screenHeight }">
    <thead>
      <tr>
        <th *ngFor="let column of columnsVisible;" 
          [nzWidth]="column.width" nzCustomFilter
          [nzSortOrder]="null"
          [nzSortDirections]="['ascend', 'descend']"
          [nzSortFn]="column.sortFn">{{ column.title }}
          <nz-filter-trigger *ngIf="column.searchable"
            [(nzVisible)]="column.searchVisible"
            [nzActive]="column.searchActive"
            [nzDropdownMenu]="menu">
            <i nz-icon nzType="search"></i>
          </nz-filter-trigger>
          <nz-dropdown-menu #menu="nzDropdownMenu">
            <div class="ant-table-filter-dropdown">
            <div class="px-2 py-2 grid grid-cols-2 gap-2">
              <input
                type="text"
                nz-input
                oninput="this.value = this.value.toUpperCase()"
                placeholder="{{ column.title }}"
                class="col-span-2"
                #searchInput
              />
              <button
                nz-button
                nzSize="small"
                nzType="primary"
                (click)="setFilter(column, searchInput.value)"
                class="search-button"
              >
                Search
              </button>
              <button nz-button nzSize="small"
                (click)="clearFilter(column)">Reset</button>
            </div>
            </div>
          </nz-dropdown-menu>
        </th>
      </tr>
    </thead>
    <tbody>
      <ng-template ngFor let-data [ngForOf]="table.data">
        <tr>
          <td *ngFor="let column of columnsVisible"
            [nzShowExpand]="column.drilldown" (nzExpandChange)="expandChange(data, column.name, $event)"
            [ngClass]="getClass(data[column.eventGroup+'StartNum'], 
            data[column.eventGroup+'DoneNum'], column.eventGroup)"
            [(nzExpand)]="data[column.title+'Expand']"
          >{{ data[column.dataName] }}</td>
        </tr>
        <tr [nzExpand]="data.expand">
          <nz-table #drillDownTable [nzData]="drilldownTableData" 
            [nzShowPagination]="false" [nzPageSize]="100" [nzScroll]="{ y: '350px' }">
            <thead>
              <tr>
                <th *ngFor="let drillColumn of drillDownColumns"
                  [nzWidth]="drillColumn.width"
                  style="background-color: #e6f3ff">
                  {{ drillColumn.name }}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let data of drillDownTable.data">
                <td *ngFor="let drillColumn of drillDownColumns">
                  {{ data[drillColumn.dataName] }}
                </td>
              </tr>
            </tbody>
          </nz-table>
        </tr>
      </ng-template>
    </tbody>
  </nz-table>
</div>