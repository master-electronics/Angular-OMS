import{a as O}from"./chunk-IPTX4HSO.js";import{b as N,d as P}from"./chunk-M47XUQY5.js";import{a as L}from"./chunk-YPJKXAYS.js";import{a as s}from"./chunk-I3G2JKLN.js";import{i as v}from"./chunk-LCEARWCQ.js";import{a as I}from"./chunk-4AGTE6D3.js";import{a as g}from"./chunk-PLQ7TNCQ.js";import{Aa as i,H as f,a as u,b as d,n as h,na as p,qa as m,va as _}from"./chunk-N7LPRJLK.js";var j=(()=>{let n=class n{get purchaseInfo(){return this._purchaseInfo.value}updatePurchaseInfo(r){this._purchaseInfo.next(u(u({},this._purchaseInfo.value),r))}get linesInfo(){return this._linesInfo.value}insertLineInfo(r){let e=this.linesInfo;e.push(r),this._linesInfo.next(e)}get leftQuantity(){return this._leftQuantity.value}updateLeftQuantity(r){this._leftQuantity.next(r)}reset(){this._purchaseInfo.next({}),this._linesInfo.next([]),this._leftQuantity.next(null)}constructor(r,e,t,a,o,y){this._receiptInfo=r,this._generateReceipt=e,this._fetchpurchase=t,this._eventLog=a,this._userInfo=o,this._insertLog=y,this._purchaseInfo=new h({}),this._linesInfo=new h([]),this._leftQuantity=new h(null)}getPurchaseOrderInfo$(r){return this.updatePurchaseInfo({PurchaseOrderNumber:r}),this._fetchpurchase.fetch({PurchaseOrderNumber:r,DistributionCenter:g.DistributionCenter}).pipe(m(e=>{if(!e.data.findPurchaseOrderH._id)throw new Error("Can't find this purchase Order!");if(!e.data.findPurchaseOrderH.PURCHASEORDERLs.length)throw new Error("Can't find line under this purchase order!")}),f(e=>{if(e.data.findPurchaseOrderH.PURCHASEORDERLs.map(t=>{if(t.QuantityOnOrder<=t.QuantityReceived)return;let a=new Date(Number(t.DueDate)),o={PurchaseLine:t.LineNumber,VendorName:e.data.findPurchaseOrderH.Vendor.VendorName,QuantityOnOrder:t.QuantityOnOrder,QuantityReceived:t.QuantityReceived,PartNumber:t.Product.PartNumber,ProductCode:t.Product.ProductCode.ProductCodeNumber,DueDate:a.toLocaleDateString()};this.insertLineInfo(o)}),!this.insertLineInfo.length)throw new Error("No line!")}),p(()=>{let e=[{UserName:this._userInfo.userName,UserEventID:s.Event_Receiving_create_receipt_start,PurchaseOrderNumber:r}];return this._eventLog.initEventLog({UserName:this._userInfo.userName,EventTypeID:s.Event_Receiving_create_receipt_start,Log:JSON.stringify({PurchaseOrderNumber:r})}),this._insertLog.mutate({oldLogs:e,eventLogs:[this._eventLog.eventLog]})}))}generateReceipt$(r,e){return this._generateReceipt.mutate({LineNumber:this.purchaseInfo.PurchaseLine,PurchaseOrderNumber:this.purchaseInfo.PurchaseOrderNumber,Quantity:this.purchaseInfo.Quantity,OverReceipt:r}).pipe(f(t=>t.data.generateReceiptForReceiving),p(t=>{this._receiptInfo.updateheaderID(t),this._eventLog.initEventLog({UserName:this._userInfo.userName,EventTypeID:s.Event_Receiving_create_receipt_done,Log:JSON.stringify(u({ReceiptHeader:t},this.purchaseInfo))});let a=[u({},this._eventLog.eventLog)],o=[{ReceiptHeader:t,UserName:this._userInfo.userName,UserEventID:s.Event_Receiving_create_receipt_done,Quantity:this.purchaseInfo.Quantity,PurchaseOrderNumber:this.purchaseInfo.PurchaseOrderNumber,PurchaseLine:this.purchaseInfo.PurchaseLine,Message:""}];return r&&(a.push({EventTypeID:s.Event_Receiving_OverReceiving_done,UserName:this._userInfo.userName,Log:JSON.stringify(d(u({},JSON.parse(this._eventLog.eventLog.Log)),{Message:`${e} to ${this.purchaseInfo.Quantity}`}))}),o.push({UserEventID:s.Event_Receiving_OverReceiving_done,Message:`${e} to ${this.purchaseInfo.Quantity}`,ReceiptHeader:t,UserName:this._userInfo.userName,Quantity:this.purchaseInfo.Quantity,PurchaseOrderNumber:this.purchaseInfo.PurchaseOrderNumber,PurchaseLine:this.purchaseInfo.PurchaseLine})),this._insertLog.mutate({oldLogs:o,eventLogs:a})}))}};n.\u0275fac=function(e){return new(e||n)(i(O),i(N),i(P),i(L),i(I),i(v))},n.\u0275prov=_({token:n,factory:n.\u0275fac});let c=n;return c})();export{j as a};
