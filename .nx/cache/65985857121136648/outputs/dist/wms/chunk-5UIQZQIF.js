import{a as Ie,b as Te}from"./chunk-FFLUMUAW.js";import{a as Oe}from"./chunk-ZT2YDPTR.js";import{a as L}from"./chunk-GC5SLUA7.js";import{a as Le,b as Ee,c as ke}from"./chunk-4DSMIZLG.js";import{e as Ne}from"./chunk-J6IIM7ZS.js";import{a as xe,b as V}from"./chunk-RMDJVRJE.js";import{a as Se,b as ye,c as ze}from"./chunk-EVXJS6DD.js";import"./chunk-KI3MUNGW.js";import"./chunk-JOHRHLSX.js";import"./chunk-OXQW4PMW.js";import{c as be,d as Fe,e as Ce}from"./chunk-6DLKQNDK.js";import{a as _e,b as ge,c as he,e as ve}from"./chunk-WUHPQNSG.js";import"./chunk-YGLVR5WL.js";import"./chunk-Z347V25R.js";import{E as ue,F as de,I as O,b as pe,d as ce,e as v,f as fe,h as U,i as E,p as M,t as k,u as R}from"./chunk-L3THJMBJ.js";import"./chunk-RAQ4VAB7.js";import"./chunk-FMSTYN27.js";import"./chunk-QQPJAVIB.js";import"./chunk-RMC6N2HF.js";import"./chunk-GJX7JKAF.js";import"./chunk-WX6KJXZ2.js";import"./chunk-EXQESRXT.js";import"./chunk-5FUULRSO.js";import{a as me,b as se}from"./chunk-V5UEWFGK.js";import"./chunk-C55YZZU5.js";import"./chunk-GFVCXK67.js";import"./chunk-WOYNEQEU.js";import"./chunk-XSY6ZNJP.js";import"./chunk-W3KGMJG7.js";import"./chunk-B3MPBRHZ.js";import"./chunk-YUDS3XHK.js";import"./chunk-MIXZFVL7.js";import"./chunk-FFJ3QZ3H.js";import{i as ae,n as le}from"./chunk-PJEV5NXI.js";import{A as N,p as w,q as j,w as ne}from"./chunk-GWV5DZOT.js";import{$b as g,Ba as T,Da as y,Fb as c,Gb as h,Gc as x,H as S,Ha as K,Hc as ie,Ia as Y,Ja as Z,Lc as re,Mb as z,Mc as oe,S as $,Sb as l,Vc as D,Y as H,a as X,ac as m,bc as s,cc as _,gc as ee,ha as q,ka as Q,ma as B,na as W,nc as b,pc as F,qa as I,wc as A,xc as C,yc as te,zc as P}from"./chunk-N7LPRJLK.js";function Ve(e,i){if(e&1&&(m(0,"label",8),C(1),s()),e&2){let r=F().$implicit;c(1),te(r.label)}}function Ge(e,i){if(e&1&&_(0,"input",9),e&2){let r=F().$implicit;l("type",r.type)("formControlName",r.name)("value",r.value)}}function Je(e,i){if(e&1&&_(0,"textarea",10),e&2){let r=F().$implicit;l("formControlName",r.name)("value",r.value)}}function $e(e,i){if(e&1&&_(0,"input",11),e&2){let r=F().$implicit;l("formControlName",r.name)("checked",r.value)}}var Ae=()=>["text","password","email","number","search","tel","url"];function Pe(e,i){if(e&1&&(m(0,"div"),g(1,Ve,2,1,"label",4)(2,Ge,1,3,"input",5)(3,Je,1,2,"textarea",6)(4,$e,1,2,"input",7),s()),e&2){let r=i.$implicit;c(1),l("ngIf",r.label!==""),c(1),l("ngIf",ie(4,Ae).includes(r.type)),c(1),l("ngIf",r.type==="textarea"),c(1),l("ngIf",r.type==="checkbox")}}var Ue=(()=>{let i=class i{constructor(){this.formSubmit=new z,this._fb=T(ue),this.myForm=this._fb.group({})}ngOnChanges(o){o.jsonFormData.firstChange||this.createForm(this.jsonFormData.controls)}createForm(o){this.myForm=this._fb.group({});for(let n of o){let t=[];for(let[f,p]of Object.entries(n.validators))switch(f){case"min":t.push(v.min(p));break;case"max":t.push(v.max(p));break;case"required":p&&t.push(v.required);break;case"requiredTrue":p&&t.push(v.requiredTrue);break;case"email":p&&t.push(v.email);break;case"minLength":t.push(v.minLength(p));break;case"maxLength":t.push(v.maxLength(p));break;case"pattern":t.push(v.pattern(p));break;case"nullValidator":p&&t.push(v.nullValidator);break;default:break}this.myForm.addControl(n.name,this._fb.control(n.value,t))}}onSubmit(){this.myForm.valid&&this.formSubmit.emit(this.myForm.value)}};i.\u0275fac=function(n){return new(n||i)},i.\u0275cmp=y({type:i,selectors:[["app-json-form"]],inputs:{jsonFormData:"jsonFormData"},outputs:{formSubmit:"formSubmit"},standalone:!0,features:[K,x],decls:5,vars:2,consts:[[3,"formGroup","ngSubmit"],[1,"mb-4","grid","grid-cols-5","gap-4"],[4,"ngFor","ngForOf"],["type","submit",1,"mb-2","mr-2","h-10","rounded-lg","bg-blue-700","px-5","py-2.5","text-sm","font-medium","text-white","hover:bg-blue-800","focus:outline-none","focus:ring-4","focus:ring-blue-300"],["class","mb-2 block text-sm font-medium text-gray-900",4,"ngIf"],["class","block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-blue-500 focus:ring-blue-500",3,"type","formControlName","value",4,"ngIf"],[3,"formControlName","value",4,"ngIf"],["type","checkbox",3,"formControlName","checked",4,"ngIf"],[1,"mb-2","block","text-sm","font-medium","text-gray-900"],[1,"block","w-full","rounded-lg","border","border-gray-300","bg-gray-50","p-2.5","text-sm","text-gray-900","focus:border-blue-500","focus:ring-blue-500",3,"type","formControlName","value"],[3,"formControlName","value"],["type","checkbox",3,"formControlName","checked"]],template:function(n,t){n&1&&(m(0,"form",0),b("ngSubmit",function(){return t.onSubmit()}),m(1,"div",1),g(2,Pe,5,5,"div",2),s(),m(3,"button",3),C(4," Submit "),s()()),n&2&&(l("formGroup",t.myForm),c(2),l("ngForOf",t.jsonFormData==null?null:t.jsonFormData.controls))},dependencies:[N,w,j,O,M,ce,pe,U,E,k,R],encapsulation:2,changeDetection:0});let e=i;return e})();function Xe(e,i){if(e&1&&C(0),e&2){let r=i.$implicit;P("and ",r.length," more selected")}}function He(e,i){if(e&1&&(m(0,"nz-form-control"),_(1,"nz-select",9),g(2,Xe,1,1,"ng-template",null,10,D),s()),e&2){let r=i.ngIf;c(1),l("nzOptions",r)}}function qe(e,i){if(e&1&&_(0,"nz-option",14),e&2){let r=i.$implicit;l("nzLabel",r.Name)("nzValue",r.Name)}}function Qe(e,i){if(e&1){let r=ee();m(0,"div",15),_(1,"input",16,17),m(3,"a",18),b("click",function(){Y(r);let n=A(2),t=F(2);return Z(t.addUser.emit(n.value))}),C(4," Add User "),s()()}}function Be(e,i){if(e&1&&(m(0,"nz-form-item",7)(1,"nz-form-control")(2,"nz-select",11),g(3,qe,1,2,"nz-option",12),s(),g(4,Qe,5,0,"ng-template",null,13,D),s()()),e&2){let r=A(5),o=F();c(2),l("nzDropdownRender",r),c(1),l("ngForOf",o.userList)}}function We(e,i){if(e&1&&C(0),e&2){let r=i.$implicit;P("and ",r.length," more selected")}}function Ke(e,i){if(e&1&&(m(0,"nz-form-control"),_(1,"nz-select",19),g(2,We,1,1,"ng-template",null,10,D),s()),e&2){let r=i.ngIf;c(1),l("nzOptions",r)}}var Me=(()=>{let i=class i{constructor(o){this.controlContainer=o,this.reset=new z,this.excel=new z,this.addUser=new z}ngOnInit(){this.filterForm=this.controlContainer.control}};i.\u0275fac=function(n){return new(n||i)(h(fe))},i.\u0275cmp=y({type:i,selectors:[["search-filter"]],inputs:{listOfEvent:"listOfEvent",userList:"userList",listOfFilter:"listOfFilter"},outputs:{reset:"reset",excel:"excel",addUser:"addUser"},standalone:!0,features:[x],decls:13,vars:4,consts:[["nz-form","",3,"formGroup"],[1,"grid","grid-cols-10","gap-3"],[1,"col-span-3"],[4,"ngIf"],["class","col-span-1",4,"ngIf"],[1,"col-span-2"],["formControlName","timeRange"],[1,"col-span-1"],[1,"mr-2","h-10","rounded-lg","border","border-gray-300","bg-white","px-5","py-2.5","text-sm","font-medium","text-gray-900","hover:bg-gray-100","focus:outline-none","focus:ring-4","focus:ring-gray-200",3,"click"],["nzMode","multiple","nzPlaceHolder","Select events","nzAllowClear","","formControlName","events",3,"nzOptions"],["tagPlaceHolder",""],["nzAllowClear","","nzShowSearch","","nzPlaceHolder","Select a User","formControlName","user",3,"nzDropdownRender"],[3,"nzLabel","nzValue",4,"ngFor","ngForOf"],["renderTemplate",""],[3,"nzLabel","nzValue"],[1,"container"],["type","text","nz-input",""],["inputElement",""],[1,"add-item",3,"click"],["nzMode","multiple","nzPlaceHolder","Select Filters","nzAllowClear","","formControlName","filter",3,"nzOptions"]],template:function(n,t){n&1&&(m(0,"form",0)(1,"div",1)(2,"nz-form-item",2),g(3,He,4,1,"nz-form-control",3),s(),g(4,Be,6,2,"nz-form-item",4),m(5,"nz-form-item",5)(6,"nz-form-control"),_(7,"nz-range-picker",6),s()(),m(8,"nz-form-item",2),g(9,Ke,4,1,"nz-form-control",3),s(),m(10,"nz-form-item",7)(11,"button",8),b("click",function(){return t.excel.emit()}),C(12," Save "),s()()()()),n&2&&(l("formGroup",t.filterForm),c(3),l("ngIf",t.listOfEvent),c(1),l("ngIf",t.userList),c(5),l("ngIf",t.listOfFilter))},dependencies:[N,w,j,O,M,U,E,k,R,ve,se,me,ge,_e,he,Ce,be,Fe,ze,Se,ye],encapsulation:2});let e=i;return e})();var Ut=(()=>{let i=class i{constructor(o,n,t,f,p,G,J){this._route=o,this._log=n,this._fb=t,this._fetchUser=f,this._fetchEvents=p,this._commonVariables=G,this.server=J,this.defaultFilter=this._fb.group({user:[""],timeRange:[],events:[],filter:[]}),this.formData=T(Ie);let u=this.defaultFilter.valueChanges.pipe(L(),B(null),q(),Q());u.pipe(L(),H(500),$(a=>a[0]?.events?.toString()!==a[1]?.events?.toString()),W(a=>this._commonVariables.fetch({events:a[1].events})),S(a=>a.data.fetchCommonvariablesForLogs.map(d=>({label:d,value:d}))),S(a=>{this.server.setListOfFilter(a)})).subscribe(),u.pipe(L(),$(a=>a[0]?.filter?.toString()!==a[1]?.filter?.toString()),S(a=>{this.formData.setJsonForm(this.server.setFilterList(a[1].filter))})).subscribe(),this._fetchUser.fetch().pipe(L(),S(a=>a.data.findUserInfos),I(a=>this.server.setFilterUser(a))).subscribe(),this._fetchEvents.fetch().pipe(L(),S(a=>a.data.findEventType.map(d=>({label:`${d.Event}-${d._id}`,value:d._id,groupLabel:d.Module})).sort(function(d,Re){return d.value-Re.value})),I(a=>this.server.setListOfEvent(a))).subscribe()}ngOnInit(){let o=X({},this._route.snapshot.queryParams);o.UserName&&this.defaultFilter.get("user").setValue(o.UserName)}addUser(o){this.server.insertUserToFilterUser({_id:-1,Name:o}),this.defaultFilter.get("user").setValue(o)}onSubmit(o){let n="";Object.keys(o).length!==0&&(n=JSON.stringify(o));let t;this.defaultFilter.value.timeRange&&(t=[this.defaultFilter.value.timeRange[0].setUTCHours(0,0,0,0).toString(),this.defaultFilter.value.timeRange[1].setUTCHours(23,59,59,999).toString()]),this.data$=this._log.fetch({Log:n,limit:500,UserName:this.defaultFilter.value.user,eventIdList:this.defaultFilter.value.events,timeFrame:t}).pipe(S(f=>{if(!f.data.findEventLogs)return null;let p=new Set,G=f.data.findEventLogs.map(u=>{let a=JSON.parse(u.Log);return Object.entries(a).map(d=>p.add(d[0])),{Name:u.UserName,Type:u.Module+" | "+u.Event,Time:u.CreateTime,Log:JSON.parse(u.Log)}}),J=[...p];return G.map(u=>{let a=u.Log;return J.map(d=>{u[d]=a[d]}),delete u.Log,u})}),I(f=>{this.ws=V.json_to_sheet(f)}))}reset(){this.formData.setJsonForm(null)}exportexcel(){let o=V.book_new();V.book_append_sheet(o,this.ws,"Sheet1"),xe(o,"Logs.xlsx")}};i.\u0275fac=function(n){return new(n||i)(h(ae),h(Le),h(de),h(Ne),h(ke),h(Ee),h(Te))},i.\u0275cmp=y({type:i,selectors:[["ng-component"]],standalone:!0,features:[x],decls:5,vars:8,consts:[[3,"formGroup","userList","listOfEvent","listOfFilter","reset","excel","addUser"],[3,"jsonFormData","formSubmit"],[1,"px-1","py-4"],[3,"data"]],template:function(n,t){n&1&&(m(0,"search-filter",0),b("reset",function(){return t.reset()})("excel",function(){return t.exportexcel()})("addUser",function(p){return t.addUser(p)}),s(),m(1,"app-json-form",1),b("formSubmit",function(p){return t.onSubmit(p)}),s(),m(2,"div",2),_(3,"table-view",3),re(4,"async"),s()),n&2&&(l("formGroup",t.defaultFilter)("userList",t.server.filterUser())("listOfEvent",t.server.listOfEvent())("listOfFilter",t.server.listOfFilter()),c(1),l("jsonFormData",t.formData.jsonForm()),c(2),l("data",oe(4,6,t.data$)))},dependencies:[N,ne,le,O,E,k,Oe,Ue,Me],encapsulation:2});let e=i;return e})();export{Ut as EventLogComponent};
