import{a as ct}from"./chunk-Z6BDTNTK.js";import{a as ut}from"./chunk-5VGBK5M2.js";import{k as at}from"./chunk-EDQ2XWAO.js";import{a as st}from"./chunk-QTNYEYCW.js";import{a as ot}from"./chunk-GKR6SDXW.js";import{a as rt}from"./chunk-XHQXBUEX.js";import"./chunk-RMIKNTFD.js";import"./chunk-D3FIXZL7.js";import"./chunk-ADHMVREX.js";import"./chunk-VJKYRYVM.js";import{j as it}from"./chunk-Y7DOXW3K.js";import"./chunk-J3DDCTFF.js";import{a as p}from"./chunk-I3G2JKLN.js";import"./chunk-LCEARWCQ.js";import{a as z}from"./chunk-4AGTE6D3.js";import"./chunk-5GWOD35Y.js";import"./chunk-POEXBOQJ.js";import{e as nt}from"./chunk-TREYRKOP.js";import{b as et}from"./chunk-MZCJXFXF.js";import{E as Y,H as Z,I as tt,e as U,i as W,t as X}from"./chunk-L3THJMBJ.js";import"./chunk-RAQ4VAB7.js";import"./chunk-RMC6N2HF.js";import"./chunk-GJX7JKAF.js";import"./chunk-WX6KJXZ2.js";import"./chunk-EXQESRXT.js";import"./chunk-5FUULRSO.js";import{c as K}from"./chunk-V5UEWFGK.js";import{a as d}from"./chunk-PLQ7TNCQ.js";import"./chunk-C55YZZU5.js";import"./chunk-GFVCXK67.js";import"./chunk-WOYNEQEU.js";import"./chunk-XSY6ZNJP.js";import"./chunk-W3KGMJG7.js";import"./chunk-B3MPBRHZ.js";import"./chunk-YUDS3XHK.js";import"./chunk-MIXZFVL7.js";import"./chunk-FFJ3QZ3H.js";import{i as H,k as q}from"./chunk-PJEV5NXI.js";import{A as G,q as j,w as Q}from"./chunk-GWV5DZOT.js";import{$b as B,Ba as R,C as u,Da as V,Fb as l,Gb as _,Gc as $,H as h,Ia as P,Ja as E,Lc as D,Mc as A,Q as J,Sb as m,V as O,ac as y,bc as N,cc as k,dc as T,ec as C,gc as M,na as f,nc as b,pc as S,qa as x}from"./chunk-N7LPRJLK.js";function mt(i,s){if(i&1&&(T(0),k(1,"audit-info",2),C()),i&2){let c=S();l(1),m("auditInfo",c.auditInfo)}}function dt(i,s){if(i&1){let c=M();T(0),y(1,"popup-modal",3),b("clickSubmit",function(){P(c);let e=S();return E(e.resetTimeout())}),N(),C()}if(i&2){let c=S();l(1),m("message",c.timeoutAlert)}}function pt(i,s){if(i&1){let c=M();T(0),y(1,"popup-modal",3),b("clickSubmit",function(){P(c);let e=S();return E(e.onFoundOk())}),N(),C()}if(i&2){let c=S();l(1),m("message",c.message)}}function It(i,s){i&1&&k(0,"div")}var Ft=(()=>{let s=class s{constructor(t,e,n,r,a,g){this._fb=t,this._actRoute=e,this._findContainer=n,this._router=r,this._eventLog=a,this._auditService=g,this.userInfo=R(z),this.inputForm=this._fb.nonNullable.group({itn:["",[U.required,U.pattern(et)]]}),this.timeoutSeconds=0}ngOnInit(){let t=JSON.parse(sessionStorage.getItem("currentAudit"));this.lastUpdated=Number(t.LastUpdated),this.info$=this._actRoute.data.pipe(h(e=>{this.auditTimeout=e?.Config?.auditTimeout?.data?.fetchConfigValue?.Value,this.alertTime=e?.Config?.alertTime?.data?.fetchConfigValue?.Value;let n=J(1e3);this.subscription=n.subscribe(r=>this.timer())})),this.data$=u(!0)}timer(){++this.timeoutSeconds;let t=(this.lastUpdated+this.auditTimeout*1e3-(this.timeoutSeconds*1e3+this.lastUpdated))/1e3;if(t==0){this._router.navigate(["../../../menu"],{relativeTo:this._actRoute});return}t==this.alertTime&&(new ct().beep(100,520),this.showTimeoutAlert=!0);let e=Math.floor(t/60),n=t%60,r=e<10?"0"+e.toString():e.toString(),a=n<10?"0"+n.toString():n.toString();this.timeoutAlert="Audit will timeout in "+r+":"+a}resetTimeout(){let t=JSON.parse(sessionStorage.getItem("currentAudit"));this.info$=this._auditService.updateLastUpdated(t.InventoryID,10,new Date(Date.now()).toISOString()).pipe(h(()=>{t.LastUpdated=new Date(Date.now()).getTime().toString(),sessionStorage.setItem("currentAudit",JSON.stringify(t))}),O(e=>u({error:e}))),this.timeoutSeconds=0,this.showTimeoutAlert=!1}onSubmit(){let t=JSON.parse(sessionStorage.getItem("currentAudit")),e=this.inputForm.value.itn,n,r,a,g=[{UserEventID:p.Event_IM_Search_ITN_Scanned,UserName:this.userInfo.userName,DistributionCenter:d.DistributionCenter,InventoryTrackingNumber:e,Message:""}],w=[{UserName:this.userInfo.userName,EventTypeID:p.Event_IM_Search_ITN_Scanned,Log:JSON.stringify({DistributionCenter:d.DistributionCenter,InventoryTrackingNumber:e})}],L=[],F=[];this.data$=this._auditService.checkBinlocation(e).pipe(f(o=>(r=JSON.parse(sessionStorage.getItem("searchLocations")),n=r?.find(I=>I.Status=="active"),a=o.data.findInventory.Container.Barcode,n.Barcode!=a&&(g.push({UserEventID:p.Event_IM_Search_ITN_Location_Updated,UserName:this.userInfo.userName,DistributionCenter:d.DistributionCenter,InventoryTrackingNumber:e,Message:"Original BinLocation: "+a+" --- New BinLocation: "+n.Barcode}),w.push({UserName:this.userInfo.userName,EventTypeID:p.Event_IM_Search_ITN_Location_Updated,Log:JSON.stringify({DistributionCenter:d.DistributionCenter,InventoryTrackingNumber:e,OriginalBinLocation:a,NewBinLocation:n.Barcode})})),this._eventLog.insertLog(g,w))),f(o=>this._auditService.closeAudits(e).pipe(h(I=>{I?.data.closeAudits.forEach(v=>{L.push({UserEventID:p.Event_IM_Audit_Closed_ITN_Search,UserName:this.userInfo.userName,DistributionCenter:d.DistributionCenter,InventoryTrackingNumber:v.InventoryTrackingNumber,Message:`Audit with _id: ${v._id} closed.  ITN: ${v.InventoryTrackingNumber}
                  found while searching for ITN: ${t.Inventory.ITN}`}),F.push({UserName:this.userInfo.userName,EventTypeID:p.Event_IM_Audit_Closed_ITN_Search,Log:JSON.stringify({DistributionCenter:d.DistributionCenter,AuditID:v._id,InventoryTrackingNumber:v.InventoryTrackingNumber,SearchedITN:t.Inventory.ITN})})})}))),f(o=>{if(L.length>0){let I="test";return this._eventLog.insertLog(L,F)}else{let I="test";return u(o)}}),f(o=>n.Barcode!=a?this._auditService.inventoryUpdate(this.userInfo.userName,e,"Inventory Management Audit","","","","","",n.Barcode):u(o)),f(o=>{if(e==JSON.parse(sessionStorage.getItem("currentAudit")).Inventory.ITN){r.forEach(v=>{v.Status="done"}),sessionStorage.setItem("searchLocations",JSON.stringify(r));let I=JSON.parse(sessionStorage.getItem("currentAudit"));return I.Container.Barcode=n.Barcode,sessionStorage.setItem("currentAudit",JSON.stringify(I)),this.message="Found ITN "+JSON.parse(sessionStorage.getItem("currentAudit")).Inventory.ITN,u(o)}return this._router.navigate(["../scan-itn"],{relativeTo:this._actRoute}),u(o)}),O(o=>u({error:{message:o.message,type:"error"}})))}onBack(){let t=JSON.parse(sessionStorage.getItem("searchLocations")),e=t?.find(n=>n.Status=="active");e.Status="done",sessionStorage.setItem("searchLocations",JSON.stringify(t)),this._router.navigate(["../scan-location"],{relativeTo:this._actRoute})}onFoundOk(){let t=JSON.parse(sessionStorage.getItem("currentAudit"));sessionStorage.setItem("auditITN",t.Inventory.ITN),this.data$=this._auditService.nextSubAudit$(t.InventoryID,this.userInfo.userId).pipe(x(e=>{if(e)return this._router.navigate(["../../"+e.Route],{relativeTo:this._actRoute}),u(!0);{let n=[{UserEventID:p.Event_IM_Audit_Completed,UserName:this.userInfo.userName,DistributionCenter:d.DistributionCenter,InventoryTrackingNumber:t.Inventory.ITN}],r=[{UserName:this.userInfo.userName,EventTypeID:p.Event_IM_Audit_Completed,Log:JSON.stringify({DistributionCenter:d.DistributionCenter,InventoryTrackingNumber:sessionStorage.getItem("auditITN"),ParentITN:t.Inventory.ParentITN,BinLocation:t.Container.Barcode,QuantityOnHand:t.Inventory.Quantity,OriginalQuantity:t.Inventory.OriginalQuantity,DateCode:t.Inventory.DateCode,CountryOfOrigin:t.Inventory.COO,ROHS:t.Inventory.ROHS,NotFound:t.Inventory.NotFound,Suspect:t.Inventory.Suspect,LocatedInAutostore:t.Inventory.LocatedInAutostore,BoundForAutostore:t.Inventory.BoundForAutostore,PartNumber:t.Inventory.Product.PartNumber,ProductCode:t.Inventory.Product.ProductCode.ProductCodeNumber,Description:t.Inventory.Product.Description,ProductTier:t.Inventory.Product.ProductTier,ProductType:t.Inventory.Product.ProductType.ProductType,ProductTypeDescription:t.Inventory.Product.ProductType.Description,Velocity:t.Inventory.Product.Velocity,MICPartNumber:t.Inventory.Product.MICPartNumber,UOM:t.Inventory.Product.UOM,Autostore:t.Inventory.Product.Autostore,PackType:t.Inventory.Product.PackType,PackQuantity:t.Inventory.Product.PackQty,Cost:t.Inventory.Product.Cost})}];return this.close$=this._eventLog.insertLog(n,r).pipe(f(a=>this._auditService.closeAudit(t.InventoryID,10,t.Inventory.ITN,this.userInfo.userName).pipe(h(g=>(this._router.navigate(["../../scan-itn"],{relativeTo:this._actRoute}),g))))),u(!0)}}))}ngOnDestroy(){this.subscription?.unsubscribe()}};s.\u0275fac=function(e){return new(e||s)(_(Y),_(H),_(it),_(q),_(st),_(at))},s.\u0275cmp=V({type:s,selectors:[["ng-component"]],standalone:!0,features:[$],decls:8,vars:13,consts:[[4,"ngIf"],["inputType","string","controlName","itn","title","Scan ITN:","backButtonText","Done",3,"data","formGroup","isvalid","formSubmit","formBack"],[3,"auditInfo"],[3,"message","clickSubmit"]],template:function(e,n){e&1&&(B(0,mt,2,1,"ng-container",0),D(1,"async"),y(2,"single-input-form",1),b("formSubmit",function(){return n.onSubmit()})("formBack",function(){return n.onBack()}),D(3,"async"),N(),B(4,dt,2,1,"ng-container",0)(5,pt,2,1,"ng-container",0)(6,It,1,0,"div",0),D(7,"async")),e&2&&(m("ngIf",A(1,7,n.info$)),l(2),m("data",A(3,9,n.data$))("formGroup",n.inputForm)("isvalid",n.inputForm.valid),l(2),m("ngIf",n.showTimeoutAlert),l(1),m("ngIf",n.message),l(1),m("ngIf",A(7,11,n.close$)))},dependencies:[G,j,Q,rt,tt,W,X,ot,nt,K,Z,ut],encapsulation:2});let i=s;return i})();export{Ft as ScanITN};
